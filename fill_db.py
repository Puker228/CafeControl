from sqlalchemy import text
from main import engine, Session as SessionLocal, Base
from datetime import datetime, timedelta

def fill_db():
    with engine.connect() as conn:
        # Очистка таблиц (в правильном порядке из-за внешних ключей)
        conn.execute(text("TRUNCATE order_compositions, orders, recipes, menu_items, ingredients, suppliers, employees, customers RESTART IDENTITY CASCADE"))
        conn.commit()

    with SessionLocal() as s:
        # 1. Customers
        customers_data = [
            ("Иван Иванов", "+7 (900) 123-45-67", "ivan@example.com", "Gold", 10.0),
            ("Мария Петрова", "+7 (911) 222-33-44", "maria@example.com", "Silver", 5.0),
            ("Алексей Смирнов", "+7 (922) 555-66-77", "alex@example.com", "Bronze", 0.0),
            ("Елена Кузнецова", "+7 (933) 888-99-00", "elena@example.com", "Gold", 10.0),
            ("Дмитрий Волков", "+7 (944) 111-22-33", "dima@example.com", "Silver", 5.0),
            ("Анна Соколова", "+7 (955) 222-33-44", "anna@example.com", "Bronze", 0.0),
            ("Сергей Морозов", "+7 (966) 333-44-55", "sergey@example.com", "Gold", 10.0),
            ("Татьяна Васильева", "+7 (977) 444-55-66", "tanya@example.com", "Silver", 5.0),
            ("Андрей Павлов", "+7 (988) 555-66-77", "andrey@example.com", "Bronze", 0.0),
            ("Наталья Федорова", "+7 (999) 666-77-88", "natalia@example.com", "Gold", 10.0),
            ("Максим Козлов", "+7 (901) 777-88-99", "maxim@example.com", "Silver", 5.0),
            ("Юлия Титова", "+7 (902) 888-99-00", "yulia@example.com", "Bronze", 0.0),
            ("Роман Лебедев", "+7 (903) 999-00-11", "roman@example.com", "Gold", 10.0),
            ("Оксана Абрамова", "+7 (904) 111-22-33", "oksana@example.com", "Silver", 5.0),
            ("Константин Белов", "+7 (905) 222-33-44", "kostya@example.com", "Bronze", 0.0),
            ("Евгения Полякова", "+7 (906) 333-44-55", "evgenia@example.com", "Gold", 10.0),
            ("Артем Савельев", "+7 (907) 444-55-66", "artem@example.com", "Silver", 5.0),
            ("Виктория Зайцева", "+7 (908) 555-66-77", "viktoria@example.com", "Bronze", 0.0),
            ("Денис Борисов", "+7 (909) 666-77-88", "denis@example.com", "Gold", 10.0),
            ("Нина Семенова", "+7 (910) 777-88-99", "nina@example.com", "Silver", 5.0),
        ]
        from main import Customer, Employee, Supplier, Ingredient, MenuItem, Recipe, Order, OrderComposition

        for name, phone, email, level, discount in customers_data:
            s.add(Customer(name=name, phone=phone, email=email, loyalty_level=level, discount_percent=discount))

        # 2. Employees
        employees_data = [
            ("Александр Бариста", "Бармен", "+7 (999) 000-11-11", 50000.0),
            ("Ольга Официантова", "Официант", "+7 (999) 000-22-22", 40000.0),
            ("Игорь Админов", "Администратор", "+7 (999) 000-33-33", 70000.0),
            ("Владимир Поваров", "Повар", "+7 (999) 000-44-44", 60000.0),
            ("Михаил Шеф", "Шеф-повар", "+7 (999) 000-55-55", 90000.0),
            ("Светлана Кассир", "Кассир", "+7 (999) 000-66-66", 45000.0),
            ("Петр Помощник", "Помощник повара", "+7 (999) 000-77-77", 35000.0),
            ("Екатерина Клининг", "Уборщица", "+7 (999) 000-88-88", 30000.0),
            ("Дмитрий Охранник", "Охранник", "+7 (999) 000-99-99", 45000.0),
            ("Мария Официантова 2", "Официант", "+7 (999) 111-00-11", 40000.0),
            ("Николай Бариста 2", "Бармен", "+7 (999) 111-00-22", 50000.0),
            ("Олег Повар 2", "Повар", "+7 (999) 111-00-33", 60000.0),
            ("Людмила Кондитер", "Кондитер", "+7 (999) 111-00-44", 55000.0),
            ("Василий Курьер", "Курьер", "+7 (999) 111-00-55", 40000.0),
            ("Ирина Менеджер", "Менеджер зала", "+7 (999) 111-00-66", 65000.0),
            ("Степан Техник", "Техник", "+7 (999) 111-00-77", 50000.0),
            ("Валентина Хостес", "Хостес", "+7 (999) 111-00-88", 42000.0),
            ("Павел Посудомойщик", "Мойщик посуды", "+7 (999) 111-00-99", 30000.0),
            ("Григорий Повар 3", "Повар", "+7 (999) 222-00-11", 60000.0),
            ("Антонина Официантова 3", "Официант", "+7 (999) 222-00-22", 40000.0),
        ]
        for fio, role, phone, salary in employees_data:
            s.add(Employee(fio=fio, role=role, phone=phone, salary=salary))

        # 3. Suppliers
        suppliers_data = [
            ("Кофейный Мир", "+7 (800) 100-10-10", "info@coffeeworld.ru", "Москва, ул. Кофейная, 1"),
            ("Молочный Край", "+7 (800) 200-20-20", "sales@milkland.ru", "СПб, пр. Молочников, 10"),
            ("Овощная База", "+7 (800) 300-30-30", "fresh@vegbase.ru", "Краснодар, ул. Дальняя, 5"),
            ("Мясной Двор", "+7 (800) 400-40-40", "meat@yard.ru", "Ростов-на-Дону, ул. Мясная, 7"),
            ("Рыбный Остров", "+7 (800) 500-50-50", "fish@island.ru", "Астрахань, наб. Волги, 2"),
            ("Специи и Травы", "+7 (800) 600-60-60", "spices@flavors.ru", "Казань, ул. Пряная, 12"),
            ("Пекарня Плюс", "+7 (800) 700-70-70", "bread@plus.ru", "Екатеринбург, пер. Хлебный, 3"),
            ("Фруктовый Сад", "+7 (800) 800-80-80", "fruit@garden.ru", "Сочи, ул. Виноградная, 45"),
            ("Чайный Дом", "+7 (800) 900-90-90", "tea@house.ru", "Владивосток, ул. Восточная, 18"),
            ("Сырная Лавка", "+7 (800) 111-22-33", "cheese@shop.ru", "Кострома, ул. Молочная, 9"),
            ("Кондитер Снаб", "+7 (800) 222-33-44", "sweet@supply.ru", "Новосибирск, ул. Сахарная, 21"),
            ("Упаковка Тут", "+7 (800) 333-44-55", "box@here.ru", "Нижний Новгород, ул. Тары, 4"),
            ("Вода Байкала", "+7 (800) 444-55-66", "water@baikal.ru", "Иркутск, ул. Чистая, 1"),
            ("Масло Завод", "+7 (800) 555-66-77", "oil@factory.ru", "Воронеж, пр. Солнечный, 15"),
            ("Зелень Города", "+7 (800) 666-77-88", "green@city.ru", "Тула, ул. Огородная, 6"),
            ("Ягодная Поляна", "+7 (800) 777-88-99", "berry@field.ru", "Пермь, ул. Лесная, 11"),
            ("Ореховый Рай", "+7 (800) 888-99-00", "nuts@paradise.ru", "Красноярск, ул. Кедровая, 32"),
            ("Грибная Корзина", "+7 (800) 999-00-11", "mushrooms@basket.ru", "Тюмень, ул. Боровая, 8"),
            ("Птицефабрика Юг", "+7 (800) 123-11-22", "poultry@south.ru", "Ставрополь, ул. Куриная, 14"),
            ("Бакалея Опт", "+7 (800) 321-22-33", "grocery@opt.ru", "Самара, ул. Складская, 50"),
        ]
        for name, phone, email, address in suppliers_data:
            s.add(Supplier(name=name, phone=phone, email=email, address=address))
        
        s.commit()

        # 4. Ingredients
        suppliers = s.query(Supplier).all()
        # Создаем словарь для быстрого доступа к id по имени (если нужно) или просто берем по порядку
        sup_dict = {sup.name: sup.id for sup in suppliers}

        ingredients_data = [
            ("Зерно Арабика", "кг", 50.0, 5.0, 1200.0, "Кофейный Мир"),
            ("Молоко 3.2%", "л", 100.0, 10.0, 80.0, "Молочный Край"),
            ("Сахар", "кг", 20.0, 2.0, 60.0, "Кофейный Мир"),
            ("Куриное филе", "кг", 15.0, 3.0, 350.0, "Птицефабрика Юг"),
            ("Салат Романо", "кг", 5.0, 1.0, 400.0, "Овощная База"),
            ("Сыр Пармезан", "кг", 3.0, 0.5, 1500.0, "Сырная Лавка"),
            ("Помидоры", "кг", 10.0, 2.0, 200.0, "Овощная База"),
            ("Огурцы", "кг", 10.0, 2.0, 150.0, "Овощная База"),
            ("Говядина", "кг", 12.0, 3.0, 600.0, "Мясной Двор"),
            ("Лосось", "кг", 8.0, 2.0, 1800.0, "Рыбный Остров"),
            ("Мука", "кг", 50.0, 10.0, 50.0, "Пекарня Плюс"),
            ("Яйца", "шт", 100.0, 20.0, 10.0, "Птицефабрика Юг"),
            ("Картофель", "кг", 30.0, 5.0, 40.0, "Овощная База"),
            ("Масло сливочное", "кг", 5.0, 1.0, 800.0, "Масло Завод"),
            ("Чай черный", "кг", 2.0, 0.5, 2000.0, "Чайный Дом"),
            ("Чай зеленый", "кг", 2.0, 0.5, 2200.0, "Чайный Дом"),
            ("Сливки 33%", "л", 10.0, 2.0, 350.0, "Молочный Край"),
            ("Шоколад", "кг", 5.0, 1.0, 1200.0, "Кондитер Снаб"),
            ("Вода газированная", "л", 50.0, 10.0, 40.0, "Вода Байкала"),
            ("Апельсины", "кг", 15.0, 3.0, 180.0, "Фруктовый Сад"),
            ("Лимоны", "кг", 5.0, 1.0, 200.0, "Фруктовый Сад"),
            ("Перец болгарский", "кг", 7.0, 1.5, 250.0, "Овощная База"),
        ]
        for name, unit, stock, min_stock, price, sup_name in ingredients_data:
            s.add(Ingredient(name=name, unit=unit, stock_quantity=stock, min_stock_level=min_stock, purchase_price=price, supplier_id=sup_dict[sup_name]))

        # 5. Menu Items
        menu_items_data = [
            ("Капучино", "Напиток", 250.0, "300 мл"),
            ("Латте", "Напиток", 280.0, "400 мл"),
            ("Эспрессо", "Напиток", 150.0, "40 мл"),
            ("Американо", "Напиток", 180.0, "200 мл"),
            ("Флэт Уайт", "Напиток", 300.0, "250 мл"),
            ("Раф Кофе", "Напиток", 350.0, "350 мл"),
            ("Чай Черный", "Напиток", 120.0, "400 мл"),
            ("Чай Зеленый", "Напиток", 120.0, "400 мл"),
            ("Салат Цезарь", "Еда", 450.0, "250 г"),
            ("Салат Греческий", "Еда", 380.0, "250 г"),
            ("Сэндвич с курицей", "Еда", 350.0, "200 г"),
            ("Сэндвич с лососем", "Еда", 480.0, "200 г"),
            ("Бургер Классик", "Еда", 550.0, "350 г"),
            ("Картофель Фри", "Еда", 200.0, "150 г"),
            ("Суп Дня", "Еда", 280.0, "300 мл"),
            ("Паста Карбонара", "Еда", 520.0, "300 г"),
            ("Омлет", "Еда", 250.0, "200 г"),
            ("Блины с творогом", "Еда", 220.0, "200 г"),
            ("Чизкейк", "Еда", 320.0, "150 г"),
            ("Тирамису", "Еда", 380.0, "150 г"),
            ("Лимонад Домашний", "Напиток", 250.0, "500 мл"),
            ("Свежевыжатый Апельсиновый", "Напиток", 300.0, "300 мл"),
        ]
        for name, type, price, vol in menu_items_data:
            s.add(MenuItem(name=name, type=type, selling_price=price, volume_or_weight=vol))
        
        s.commit()

        # 6. Recipes
        ing_dict = {ing.name: ing.id for ing in s.query(Ingredient).all()}
        menu_dict = {item.name: item.id for item in s.query(MenuItem).all()}

        recipes_data = [
            ("Капучино", "Зерно Арабика", 0.02, "кг"),
            ("Капучино", "Молоко 3.2%", 0.2, "л"),
            ("Латте", "Зерно Арабика", 0.02, "кг"),
            ("Латте", "Молоко 3.2%", 0.25, "л"),
            ("Эспрессо", "Зерно Арабика", 0.015, "кг"),
            ("Американо", "Зерно Арабика", 0.015, "кг"),
            ("Флэт Уайт", "Зерно Арабика", 0.02, "кг"),
            ("Флэт Уайт", "Молоко 3.2%", 0.15, "л"),
            ("Раф Кофе", "Зерно Арабика", 0.02, "кг"),
            ("Раф Кофе", "Сливки 33%", 0.2, "л"),
            ("Чай Черный", "Чай черный", 0.005, "кг"),
            ("Чай Зеленый", "Чай зеленый", 0.005, "кг"),
            ("Салат Цезарь", "Куриное филе", 0.1, "кг"),
            ("Салат Цезарь", "Салат Романо", 0.05, "кг"),
            ("Салат Цезарь", "Сыр Пармезан", 0.02, "кг"),
            ("Салат Цезарь", "Помидоры", 0.03, "кг"),
            ("Салат Греческий", "Помидоры", 0.05, "кг"),
            ("Салат Греческий", "Огурцы", 0.05, "кг"),
            ("Салат Греческий", "Перец болгарский", 0.03, "кг"),
            ("Салат Греческий", "Сыр Пармезан", 0.02, "кг"), # Пусть будет пармезан для простоты
            ("Сэндвич с курицей", "Куриное филе", 0.07, "кг"),
            ("Сэндвич с курицей", "Помидоры", 0.02, "кг"),
            ("Сэндвич с лососем", "Лосось", 0.05, "кг"),
            ("Сэндвич с лососем", "Огурцы", 0.02, "кг"),
            ("Бургер Классик", "Говядина", 0.15, "кг"),
            ("Бургер Классик", "Помидоры", 0.02, "кг"),
            ("Картофель Фри", "Картофель", 0.2, "кг"),
            ("Омлет", "Яйца", 3, "шт"),
            ("Омлет", "Молоко 3.2%", 0.05, "л"),
            ("Блины с творогом", "Мука", 0.05, "кг"),
            ("Блины с творогом", "Яйца", 1, "шт"),
            ("Чизкейк", "Сыр Пармезан", 0.1, "кг"), # Условно
            ("Тирамису", "Сливки 33%", 0.1, "л"),
            ("Тирамису", "Яйца", 1, "шт"),
            ("Лимонад Домашний", "Лимоны", 0.05, "кг"),
            ("Лимонад Домашний", "Сахар", 0.02, "кг"),
            ("Свежевыжатый Апельсиновый", "Апельсины", 0.3, "кг"),
        ]
        for m_name, i_name, qty, unit in recipes_data:
            s.add(Recipe(menu_item_id=menu_dict[m_name], ingredient_id=ing_dict[i_name], quantity_required=qty, unit=unit))

        s.commit()

        # 7. Orders
        customers = s.query(Customer).all()
        employees = s.query(Employee).all()
        menu_items = s.query(MenuItem).all()
        
        import random
        random.seed(42)

        for i in range(20):
            cust = random.choice(customers + [None])
            emp = random.choice(employees)
            o_type = random.choice(["В заведении", "С собой"])
            p_method = random.choice(["Карта", "Наличные", "QR-код"])
            status = random.choice(["Новый", "В работе", "Готов", "Оплачен"])
            
            order = Order(
                customer_id=cust.id if cust else None,
                employee_id=emp.id,
                order_type=o_type,
                payment_method=p_method,
                status=status,
                order_date=datetime.now() - timedelta(days=random.randint(0, 30), hours=random.randint(0, 12))
            )
            s.add(order)
            s.flush()

            # 8. Order Composition
            # Добавляем 1-3 позиции в каждый заказ
            for _ in range(random.randint(1, 3)):
                item = random.choice(menu_items)
                qty = random.randint(1, 2)
                s.add(OrderComposition(
                    order_id=order.id,
                    menu_item_id=item.id,
                    quantity=qty,
                    price_at_sale=item.selling_price
                ))

        s.commit()
    print("База данных успешно заполнена тематическими данными!")

if __name__ == "__main__":
    fill_db()
